<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kyber Crystal Attunement // Black Spire Outpost</title>
  <meta name="theme-color" content="#050607" />
  <style>
    :root{
      --bg:#050607;
      --panel:#0c0f12;
      --text:#e7e7e7;
      --muted:#9aa6b2;
      --line:#1b2530;
      --accent:#4ad3ff;
      --good:#67ffb8;
      --warn:#ffb84a;

      --c-green:#44ff8a;
      --c-blue:#4aa3ff;
      --c-red:#ff4a4a;
      --c-yellow:#ffd24a;
      --c-black:#0b0b10;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:
        radial-gradient(1100px 700px at 50% -20%, #0b1a26 0%, var(--bg) 55%) fixed,
        radial-gradient(900px 500px at 120% 30%, rgba(74,211,255,0.06) 0%, transparent 55%) fixed;
      color:var(--text);
      letter-spacing:0.2px;
      overflow-x:hidden;
    }

    /* CRT scanlines + vignette */
    .crt::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.03) 0px,
          rgba(255,255,255,0.03) 1px,
          rgba(0,0,0,0.00) 2px,
          rgba(0,0,0,0.00) 4px
        );
      mix-blend-mode:overlay;
      opacity:0.35;
    }
    .crt::after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background: radial-gradient(900px 500px at 50% 20%, transparent 0%, rgba(0,0,0,0.55) 70%);
      opacity:0.7;
    }

    .wrap{
      max-width:820px;
      margin:0 auto;
      padding:24px 16px 44px;
      position:relative;
      z-index:1;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:12px;
    }
    .badge{
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:14px;
      background: rgba(12,15,18,0.65);
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
      width:fit-content;
    }
    .badge strong{ color:var(--text); font-weight:700; }

    .panel{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(12,15,18,0.72);
      box-shadow: 0 12px 34px rgba(0,0,0,0.36);
      overflow:hidden;
      position:relative;
    }
    .panelTop{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(19,27,36,0.75), rgba(12,15,18,0.35));
    }
    .title{
      font-size:14px;
      margin:0;
      color:var(--muted);
    }
    .status{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 16px rgba(74,211,255,0.75);
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform:scale(1); opacity:0.55 }
      50%{ transform:scale(1.25); opacity:1 }
    }

    .content{ padding:18px 16px 16px; }

    .h1{
      margin:0 0 8px;
      font-size:20px;
      letter-spacing:0.4px;
    }
    .sub{
      margin:0 0 14px;
      font-size:13px;
      color:var(--muted);
      line-height:1.55;
      white-space:pre-line;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    button{
      border:1px solid var(--line);
      background: rgba(7,10,12,0.45);
      color:var(--text);
      padding:11px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
      font: inherit;
      font-size:13px;
    }
    button:hover{ border-color: rgba(74,211,255,0.55); }
    button:active{ transform: translateY(1px); }
    .primary{
      border-color: rgba(74,211,255,0.45);
      box-shadow: 0 0 0 2px rgba(74,211,255,0.08) inset;
    }
    .ghost{
      background: transparent;
      color: var(--muted);
    }

    .choice{
      width:100%;
      text-align:left;
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px 12px;
    }
    .choice .k{
      flex:0 0 auto;
      width:18px; height:18px;
      border-radius:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,0.03);
      margin-top:2px;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.25) inset;
    }
    .choice .t{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .choice .t strong{ font-weight:700; }
    .choice .t span{
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    /* Visual modules */
    .viz{
      border:1px solid var(--line);
      border-radius:16px;
      background: radial-gradient(600px 220px at 50% 0%, rgba(74,211,255,0.10), transparent 65%);
      padding:14px 12px;
      position:relative;
      overflow:hidden;
      min-height:120px;
    }
    .viz .label{
      font-size:12px;
      color:var(--muted);
      margin:0 0 10px;
    }

    /* Hologram ring */
    .ring{
      width:92px; height:92px;
      border-radius:50%;
      margin:10px auto 0;
      border:1px solid rgba(74,211,255,0.35);
      box-shadow:
        0 0 22px rgba(74,211,255,0.18),
        inset 0 0 22px rgba(74,211,255,0.15);
      position:relative;
      animation: ringSpin 5.5s linear infinite;
    }
    .ring::before{
      content:"";
      position:absolute; inset:10px;
      border-radius:50%;
      border:1px dashed rgba(74,211,255,0.35);
      filter: blur(0.1px);
    }
    .ring::after{
      content:"";
      position:absolute; inset:26px;
      border-radius:50%;
      background: radial-gradient(circle at 50% 40%, rgba(255,255,255,0.06), transparent 60%);
      border:1px solid rgba(74,211,255,0.20);
    }
    @keyframes ringSpin{ to { transform: rotate(360deg); } }

    /* Shimmer sweep */
    .viz::after{
      content:"";
      position:absolute;
      top:-30%;
      left:-40%;
      width:40%;
      height:160%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
      transform: rotate(18deg);
      animation: sweep 3.8s ease-in-out infinite;
      opacity:0.9;
    }
    @keyframes sweep{
      0%,40% { transform: translateX(-40%) rotate(18deg); opacity:0; }
      55% { opacity:0.9; }
      100% { transform: translateX(380%) rotate(18deg); opacity:0; }
    }

    /* Static glitch overlay */
    .static{
      position:fixed; inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(0deg,
          rgba(255,255,255,0.02) 0px,
          rgba(255,255,255,0.02) 1px,
          rgba(0,0,0,0) 2px,
          rgba(0,0,0,0) 5px
        ),
        repeating-linear-gradient(90deg,
          rgba(255,255,255,0.01) 0px,
          rgba(255,255,255,0.01) 1px,
          rgba(0,0,0,0) 2px,
          rgba(0,0,0,0) 6px
        );
      opacity:0;
      mix-blend-mode:overlay;
      z-index:999;
    }
    .static.on{
      opacity:0.75;
      animation: staticBurst 450ms steps(2) 1;
    }
    @keyframes staticBurst{
      0%{ transform: translate(0,0); filter: blur(0px); }
      20%{ transform: translate(-2px,1px); filter: blur(.2px); }
      40%{ transform: translate(2px,-1px); filter: blur(.3px); }
      60%{ transform: translate(-1px,-2px); filter: blur(.2px); }
      100%{ transform: translate(0,0); filter: blur(0px); }
    }

    /* “Kyber aura” block */
    .aura{
      height:10px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(74,211,255,0.0), rgba(74,211,255,0.55), rgba(74,211,255,0.0));
      box-shadow: 0 0 18px rgba(74,211,255,0.22);
      animation: aura 1.9s ease-in-out infinite;
    }
    @keyframes aura{
      0%,100%{ transform: scaleX(0.8); opacity:0.45; }
      50%{ transform: scaleX(1.05); opacity:0.95; }
    }

    /* Progress bar */
    .bar{
      width:100%;
      height:12px;
      border:1px solid var(--line);
      border-radius:999px;
      overflow:hidden;
      background: rgba(0,0,0,0.35);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(74,211,255,0.25), rgba(74,211,255,0.75));
      box-shadow: 0 0 18px rgba(74,211,255,0.20);
      transition: width 120ms linear;
    }

    /* Result glow */
    .resultBox{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px 12px;
      background: rgba(0,0,0,0.25);
      position:relative;
      overflow:hidden;
    }
    .resultBox .big{
      font-size:22px;
      margin:0 0 6px;
      letter-spacing:0.6px;
      white-space:pre-line;
    }
    .resultBox .small{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
      white-space:pre-line;
    }
    .glow{
      position:absolute; inset:-60px;
      opacity:0.22;
      filter: blur(8px);
      pointer-events:none;
    }

    .tiny{
      font-size:11px;
      color:var(--muted);
      margin-top:10px;
      line-height:1.55;
    }
    .link{
      background:transparent;
      border:none;
      padding:0;
      color: var(--accent);
      cursor:pointer;
      text-decoration: underline;
      font: inherit;
      font-size:12px;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body class="crt">
  <div class="static" id="static"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="badge">
        <strong>BLACK SPIRE OUTPOST</strong><br/>
        Batuu // Subsector 12<br/>
        Kyber Handling Terminal
      </div>
      <div class="badge">
        SESSION: <span id="sessionId">—</span><br/>
        LINK: NFC INITIATED
      </div>
    </div>

    <div class="panel">
      <div class="panelTop">
        <p class="title" id="panelTitle">KYBER ATTUNEMENT PROTOCOL</p>
        <div class="status"><span class="dot"></span><span id="panelStatus">STANDBY</span></div>
      </div>

      <div class="content">

        <!-- PAGE 1 -->
        <section class="page" id="p1">
          <h1 class="h1">Initialize Force Attunement</h1>
          <p class="sub">
Place your hand over the chamber.
Breathe once. Let Batuu fall away.</p>

          <div class="grid">
            <div class="viz">
              <p class="label">SIGNAL // LOW-POWER RESONANCE</p>
              <div class="aura"></div>
              <div class="ring" aria-hidden="true"></div>
              <p class="tiny">
                NOTE: This terminal does not store identity. It only reads resonance.
              </p>
            </div>
          </div>

          <div class="btnRow">
            <button class="primary" onclick="go(2, {glitch:true})">BEGIN</button>
            <button class="ghost" onclick="softReset()">RESET</button>
          </div>
        </section>

        <!-- PAGE 2 -->
        <section class="page hidden" id="p2">
          <h1 class="h1">Resonance Detected</h1>
          <p class="sub">
The Force resonates strongly.
Do not chase it. Let it approach.</p>

          <div class="grid">
            <div class="viz">
              <p class="label">FIELD // STABLE • HARMONIC</p>
              <div class="aura"></div>
              <div style="margin-top:10px; border:1px solid var(--line); border-radius:14px; padding:12px; background:rgba(0,0,0,0.22);">
                <div style="display:flex; justify-content:space-between; gap:10px; font-size:12px; color:var(--muted);">
                  <span>VECTOR DRIFT</span><span>±0.04</span>
                </div>
                <div style="height:10px; border-radius:999px; background:rgba(255,255,255,0.03); margin-top:8px; overflow:hidden; border:1px solid var(--line);">
                  <div id="drift" style="height:100%; width:56%; background:linear-gradient(90deg, rgba(74,211,255,0.18), rgba(74,211,255,0.65)); box-shadow:0 0 14px rgba(74,211,255,0.20);"></div>
                </div>
                <p class="tiny" style="margin:10px 0 0;">
                  When you answer, choose what feels true—fast. The crystal listens to instinct.
                </p>
              </div>
            </div>
          </div>

          <div class="btnRow">
            <button class="primary" onclick="go(3)">CONTINUE</button>
            <button class="ghost" onclick="go(1)">BACK</button>
          </div>
        </section>

        <!-- PAGE 3 (Q1) -->
        <section class="page hidden" id="p3">
          <h1 class="h1">Attunement I</h1>
          <p class="sub">When pressure rises, your first impulse is to…</p>

          <div class="grid">
            <div class="viz">
              <p class="label">HOLO // CONFLICT TRACE</p>
              <div class="ring" aria-hidden="true"></div>
              <div class="tiny">Select one response.</div>
            </div>

            <button class="choice" onclick="answer('q1','protect')">
              <span class="k"></span>
              <span class="t"><strong>Protect</strong><span>Stand between danger and what matters.</span></span>
            </button>

            <button class="choice" onclick="answer('q1','observe')">
              <span class="k"></span>
              <span class="t"><strong>Observe</strong><span>Read the room. Map the threat. Then move.</span></span>
            </button>

            <button class="choice" onclick="answer('q1','act')">
              <span class="k"></span>
              <span class="t"><strong>Act</strong><span>Cut a path. Make momentum before it’s taken.</span></span>
            </button>
          </div>

          <div class="btnRow">
            <button class="ghost" onclick="go(2)">BACK</button>
          </div>
        </section>

        <!-- PAGE 4 (Q2) -->
        <section class="page hidden" id="p4">
          <h1 class="h1">Attunement II</h1>
          <p class="sub">Power is best understood as…</p>

          <div class="grid">
            <div class="viz">
              <p class="label">HOLO // OUTPUT SIGNATURE</p>
              <div class="aura"></div>
              <div style="display:flex; gap:8px; justify-content:center; margin-top:12px;">
                <div style="width:14px; height:42px; border:1px solid var(--line); border-radius:10px; background:rgba(74,211,255,0.10); animation:col 1.7s ease-in-out infinite;"></div>
                <div style="width:14px; height:58px; border:1px solid var(--line); border-radius:10px; background:rgba(74,211,255,0.12); animation:col 1.9s ease-in-out infinite;"></div>
                <div style="width:14px; height:34px; border:1px solid var(--line); border-radius:10px; background:rgba(74,211,255,0.08); animation:col 1.6s ease-in-out infinite;"></div>
                <div style="width:14px; height:66px; border:1px solid var(--line); border-radius:10px; background:rgba(74,211,255,0.14); animation:col 2.0s ease-in-out infinite;"></div>
              </div>
              <style>@keyframes col{0%,100%{transform:translateY(0);opacity:.6}50%{transform:translateY(-6px);opacity:1}}</style>
              <div class="tiny" style="text-align:center; margin-top:10px;">Select one response.</div>
            </div>

            <button class="choice" onclick="answer('q2','responsibility')">
              <span class="k"></span>
              <span class="t"><strong>Responsibility</strong><span>It must be carried, not flaunted.</span></span>
            </button>

            <button class="choice" onclick="answer('q2','tool')">
              <span class="k"></span>
              <span class="t"><strong>A Tool</strong><span>Useful. Neutral. Defined by the hand that holds it.</span></span>
            </button>

            <button class="choice" onclick="answer('q2','weapon')">
              <span class="k"></span>
              <span class="t"><strong>A Weapon</strong><span>Meant to be decisive. Meant to end things.</span></span>
            </button>
          </div>

          <div class="btnRow">
            <button class="ghost" onclick="go(3)">BACK</button>
          </div>
        </section>

        <!-- PAGE 5 (Q3) -->
        <section class="page hidden" id="p5">
          <h1 class="h1">Attunement III</h1>
          <p class="sub">Your compass points toward…</p>

          <div class="grid">
            <div class="viz">
              <p class="label">HOLO // PATH INDEX</p>
              <div class="ring" aria-hidden="true"></div>
              <div class="aura" style="margin-top:12px;"></div>
              <div class="tiny" style="text-align:center; margin-top:10px;">Select one response.</div>
            </div>

            <button class="choice" onclick="answer('q3','loyalty')">
              <span class="k"></span>
              <span class="t"><strong>Loyalty</strong><span>You don’t abandon your people.</span></span>
            </button>

            <button class="choice" onclick="answer('q3','knowledge')">
              <span class="k"></span>
              <span class="t"><strong>Knowledge</strong><span>Truth first. The rest follows.</span></span>
            </button>

            <button class="choice" onclick="answer('q3','freedom')">
              <span class="k"></span>
              <span class="t"><strong>Freedom</strong><span>Your path is yours—always.</span></span>
            </button>
          </div>

          <div class="btnRow">
            <button class="ghost" onclick="go(4)">BACK</button>
          </div>
        </section>

        <!-- PAGE 6 (LOADING) -->
        <section class="page hidden" id="p6">
          <h1 class="h1">Calibrating Kyber Resonance</h1>
          <p class="sub" id="loadText">Sampling field harmonics…</p>

          <div class="grid">
            <div class="viz">
              <p class="label">ANALYSIS // RUNNING</p>
              <div class="bar"><div id="barFill"></div></div>
              <p class="tiny" id="loadLines" style="margin-top:10px;">
                &gt; establishing baseline…<br/>
                &gt; correcting drift…<br/>
                &gt; isolating signature…
              </p>
            </div>
          </div>

          <div class="btnRow">
            <button class="ghost" onclick="softReset()">ABORT</button>
          </div>
        </section>

        <!-- PAGE 7 (RESULT) -->
        <section class="page hidden" id="p7">
          <h1 class="h1">Attunement Complete</h1>
          <p class="sub" id="resultSubtitle">The terminal has a recommendation. The choice is still yours.</p>

          <div class="grid">
            <div class="resultBox" id="resultBox">
              <div class="glow" id="glow"></div>
              <p class="big" id="resultName">—</p>
              <p class="small" id="resultLore">—</p>
            </div>

            <div class="viz">
              <p class="label">FINAL // TRANSFER PROTOCOL</p>
              <div class="aura"></div>
              <p class="tiny" style="margin-top:12px;">
                Present the chamber. Receive the crystal.
              </p>
            </div>
          </div>

          <div class="btnRow">
            <button class="primary" onclick="accept()">ACCEPT ALIGNMENT</button>
            <button class="ghost" onclick="toggleOverride(true)">If you feel the Force was mistaken today…</button>
            <button class="ghost" onclick="softReset()">NEW ATTUNEMENT</button>
          </div>

          <div class="grid hidden" id="overridePanel" style="margin-top:12px;">
            <div class="resultBox">
              <p class="big" style="margin:0 0 6px;">Pick from Available Stockpile</p>
              <p class="small" style="margin:0 0 10px;">
                Sometimes the field is noisy. Choose what calls to you—no judgment.
              </p>

              <div class="btnRow" style="margin-top:0;">
                <button onclick="manualPick('Yellow')">Yellow</button>
                <button onclick="manualPick('Blue')">Blue</button>
                <button onclick="manualPick('Green')">Green</button>
                <button onclick="manualPick('Red')">Red</button>
                <!-- If you EVER want Black selectable, add:
                <button onclick="manualPick('Black')">Black</button>
                -->
                <button class="ghost" onclick="toggleOverride(false)">Never mind</button>
              </div>

              <p class="tiny" style="margin-top:10px;">
                NOTE: Black is not listed. If it appears, it’s a true anomaly.
              </p>
            </div>
          </div>

          <p class="tiny">
            <button class="link" onclick="showCredits()">terminal notes</button>
            <span id="credits" class="hidden">
              — built for Batuu-bound travelers. no data stored. no tracking. —
            </span>
          </p>
        </section>

      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    // Super rare BLACK outcome chance (independent of answers).
    // Set 0.02 = 2% (about 1 in 50). Try 0.01 if you want it rarer.
    const BLACK_RARE_CHANCE = 0.02;

    // Optional tiny randomness for normal colors (leave at 0 for pure scoring).
    const RARE_GLITCH_CHANCE = 0.00;

    // Batuu-ish session prefix
    const SESSION_PREFIX = "BSP";

    // ====== STATE ======
    const state = {
      page: 1,
      answers: { q1:null, q2:null, q3:null },
      scores: { Yellow:0, Blue:0, Green:0, Red:0, Black:0 },
      result: null
    };

    const pages = ["p1","p2","p3","p4","p5","p6","p7"];
    const $ = (id) => document.getElementById(id);

    function randId(){
      const s = Math.random().toString(36).slice(2,6).toUpperCase();
      const t = Math.random().toString(36).slice(2,6).toUpperCase();
      return `${SESSION_PREFIX}-${s}${t}`;
    }

    function staticGlitch(){
      const el = $("static");
      el.classList.remove("on");
      void el.offsetWidth;
      el.classList.add("on");
      setTimeout(()=>el.classList.remove("on"), 520);
    }

    function setHeader(title, status){
      $("panelTitle").textContent = title;
      $("panelStatus").textContent = status;
    }

    function driftWobble(){
      const el = $("drift");
      if(!el) return;
      let w = 52 + Math.random()*18;
      el.style.width = `${w.toFixed(0)}%`;
    }

    function go(n, opts={}){
      pages.forEach(pid => $(pid).classList.add("hidden"));
      $(`p${n}`).classList.remove("hidden");
      state.page = n;

      if(opts.glitch) staticGlitch();

      switch(n){
        case 1:
          setHeader("KYBER ATTUNEMENT PROTOCOL", "STANDBY");
          break;
        case 2:
          setHeader("RESONANCE FIELD MONITOR", "LOCKED");
          driftWobble();
          break;
        case 3:
          setHeader("ATTUNEMENT // PHASE I", "INPUT REQUIRED");
          break;
        case 4:
          setHeader("ATTUNEMENT // PHASE II", "INPUT REQUIRED");
          break;
        case 5:
          setHeader("ATTUNEMENT // PHASE III", "INPUT REQUIRED");
          break;
        case 6:
          setHeader("CALIBRATION // ANALYSIS", "RUNNING");
          runLoadingThenResult();
          break;
        case 7:
          setHeader("RESULT // KYBER RECOMMENDATION", "COMPLETE");
          break;
      }
    }

    function answer(q, v){
      state.answers[q] = v;
      staticGlitch(); // makes it feel terminal-ish
      if(q === "q1") go(4);
      if(q === "q2") go(5);
      if(q === "q3") go(6);
    }

    function score(){
      // reset
      for(const k of Object.keys(state.scores)) state.scores[k] = 0;

      const {q1,q2,q3} = state.answers;

      // --- Normal scoring (Blue/Green/Yellow/Red) ---
      // Q1: impulse under pressure
      if(q1 === "protect"){ state.scores.Blue += 3; state.scores.Green += 1; }
      if(q1 === "observe"){ state.scores.Green += 3; state.scores.Yellow += 1; }
      if(q1 === "act"){ state.scores.Red += 3; state.scores.Yellow += 1; }

      // Q2: meaning of power
      if(q2 === "responsibility"){ state.scores.Blue += 3; state.scores.Green += 1; }
      if(q2 === "tool"){ state.scores.Yellow += 3; state.scores.Green += 1; }
      if(q2 === "weapon"){ state.scores.Red += 3; state.scores.Yellow += 1; }

      // Q3: compass
      if(q3 === "loyalty"){ state.scores.Blue += 3; state.scores.Green += 1; }
      if(q3 === "knowledge"){ state.scores.Green += 3; state.scores.Yellow += 1; }
      if(q3 === "freedom"){ state.scores.Yellow += 3; state.scores.Red += 1; }

      // Optional tiny nudge
      if(Math.random() < RARE_GLITCH_CHANCE){
        const keys = ["Yellow","Blue","Green","Red"];
        state.scores[keys[(Math.random()*keys.length)|0]] += 1;
      }

      // --- BLACK rare roll (super rare / cinematic) ---
      if(Math.random() < BLACK_RARE_CHANCE){
        state.result = "Black";
        return "Black";
      }

      // Tie-break preference order (earlier wins ties)
      const pref = ["Yellow","Blue","Green","Red"];

      let best = pref[0], bestScore = -Infinity;
      for(const k of pref){
        const s = state.scores[k];
        if(s > bestScore){ bestScore = s; best = k; }
      }

      state.result = best;
      return best;
    }

    function loreFor(color){
      const lore = {
        Yellow: {
          title: "YELLOW — The Choice of the True",
          text:
            "Clarity without cruelty. Purpose without noise.\n" +
            "You move with intent—and Batuu doesn’t miss it."
        },
        Blue: {
          title: "BLUE — The Oath of the Guardian",
          text:
            "You stand when others step back.\n" +
            "The crystal answers your steadiness, like a beacon through dust storms."
        },
        Green: {
          title: "GREEN — The Quiet Current",
          text:
            "Patience is not hesitation. Wisdom is not softness.\n" +
            "Your resonance is steady—like stone warmed by twin suns."
        },
        Red: {
          title: "RED — The Claim of Power",
          text:
            "The field sharpens around you.\n" +
            "It does not ask permission. It waits to see if you will take what you want."
        },
        Black: {
          title: "BLACK — The Void Answered",
          text:
            "A silence behind the signal.\n" +
            "Something ancient stirs in the lattice.\n" +
            "Keep your grip—Batuu remembers what it feeds."
        }
      };
      return lore[color] || lore.Yellow;
    }

    function colorToCSS(color){
      return {
        Yellow: "var(--c-yellow)",
        Blue: "var(--c-blue)",
        Green: "var(--c-green)",
        Red: "var(--c-red)",
        Black: "var(--c-black)"
      }[color] || "var(--accent)";
    }

    function runLoadingThenResult(){
      const color = score();

      const bar = $("barFill");
      const loadText = $("loadText");
      const loadLines = $("loadLines");

      let p = 0;
      bar.style.width = "0%";
      loadText.textContent = "Sampling field harmonics…";
      loadLines.innerHTML = "&gt; establishing baseline…<br/>&gt; correcting drift…<br/>&gt; isolating signature…";

      const steps = [
        {t:"Sampling field harmonics…", lines:["establishing baseline…","correcting drift…","isolating signature…"]},
        {t:"Filtering atmospheric interference…", lines:["shielding coils…","phase matching…","rejecting noise…"]},
        {t:"Aligning kyber lattice…", lines:["harmonics stabilized…","signal lock acquired…","final comparison…"]},
        {t:"Finalizing recommendation…", lines:["mapping signature…","confirming output…","transfer ready…"]}
      ];

      // Make BLACK feel like the terminal is struggling
      if(color === "Black"){
        steps[1].t = "WARNING: anomalous silence detected…";
        steps[2].t = "Containment routines failing…";
        steps[3].t = "FORCING RECOMMENDATION…";
        steps[1].lines = ["signal dropped to zero…","reacquiring…","do not interrupt…"];
        steps[2].lines = ["lattice pressure rising…","field destabilizing…","hold steady…"];
        steps[3].lines = ["no match found…","accepting void…","transfer ready…"];
      }

      let stepIdx = 0;

      const timer = setInterval(()=>{
        p += 3 + Math.random()*7;
        if(p > 100) p = 100;
        bar.style.width = `${p.toFixed(0)}%`;

        if(p > 25 && stepIdx === 0){ stepIdx=1; }
        if(p > 50 && stepIdx === 1){ stepIdx=2; }
        if(p > 75 && stepIdx === 2){ stepIdx=3; }

        const s = steps[stepIdx];
        loadText.textContent = s.t;
        loadLines.innerHTML = `&gt; ${s.lines[0]}<br/>&gt; ${s.lines[1]}<br/>&gt; ${s.lines[2]}`;

        // glitch behavior
        if(color === "Black"){
          if(Math.random() < 0.35) staticGlitch();
        } else {
          if(Math.random() < 0.12) staticGlitch();
        }

        if(p >= 100){
          clearInterval(timer);
          setTimeout(()=>renderResult(color), 450);
        }
      }, 140);
    }

    function renderResult(color){
      const l = loreFor(color);

      $("resultName").textContent = l.title;
      $("resultLore").textContent = l.text;

      const c = colorToCSS(color);
      $("glow").style.background = `radial-gradient(circle at 50% 30%, ${c}, transparent 62%)`;

      // Subtitle + dramatic effect for BLACK
      if(color === "Black"){
        $("resultSubtitle").textContent = "The terminal did not expect this. Proceed carefully.";
        staticGlitch(); setTimeout(staticGlitch, 160); setTimeout(staticGlitch, 320);
      } else {
        $("resultSubtitle").textContent = "The terminal has a recommendation. The choice is still yours.";
      }

      go(7, {glitch:true});
    }

    function toggleOverride(on){
      $("overridePanel").classList.toggle("hidden", !on);
      if(on) staticGlitch();
    }

    function accept(){
      staticGlitch();
      const msg =
        `Alignment accepted: ${state.result}\n\n` +
        `Present the chamber.\nReceive the crystal.`;
      alert(msg);
    }

    function manualPick(color){
      staticGlitch();
      const l = loreFor(color);

      $("resultName").textContent = l.title + " (Manual Selection)";
      $("resultLore").textContent =
        "Chosen by will, not signal.\n" +
        l.text;

      const c = colorToCSS(color);
      $("glow").style.background = `radial-gradient(circle at 50% 30%, ${c}, transparent 62%)`;

      $("resultSubtitle").textContent =
        "Override accepted. The Force is vast—and sometimes it whispers differently.";

      toggleOverride(false);
    }

    function softReset(){
      staticGlitch();
      state.answers = { q1:null, q2:null, q3:null };
      state.result = null;
      toggleOverride(false);
      go(1);
    }

    function showCredits(){
      $("credits").classList.toggle("hidden");
    }

    // init
    $("sessionId").textContent = randId();
    go(1);
  </script>
</body>
</html>
